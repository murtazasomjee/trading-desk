<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Desk — 30 Day Challenge</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:      #eef1f6;
    --surface: #ffffff;
    --surface2:#f4f6f9;
    --border:  #d0d7e2;
    --navy:    #00427a;
    --blue:    #0077c2;
    --green:   #1a7f3c;
    --red:     #c41230;
    --text:    #1a2332;
    --muted:   #64748b;
    --sans:    'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    padding: 24px 32px 48px;
    font-size: 14px;
  }

  /* ── Header ── */
  .header {
    background: var(--surface);
    border-radius: 8px;
    padding: 18px 28px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    box-shadow: 0 1px 4px rgba(0,66,122,0.08);
    border-top: 4px solid var(--navy);
  }
  .header h1 { font-size: 20px; font-weight: 600; color: var(--navy); }
  .header .subtitle { font-size: 12px; color: var(--muted); margin-top: 3px; }
  .header-right { text-align: right; }
  .day-badge {
    display: inline-block;
    background: var(--navy);
    color: #fff;
    padding: 3px 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1px;
    border-radius: 3px;
    margin-bottom: 4px;
  }
  .date-display { font-size: 12px; color: var(--muted); }

  /* ── Live price bar ── */
  .live-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 9px 18px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 12px;
    color: var(--muted);
    box-shadow: 0 1px 3px rgba(0,66,122,0.04);
  }
  .live-bar .pulse {
    display: inline-block;
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--green);
    margin-right: 7px;
    animation: pulse 2s infinite;
  }
  .live-bar .pulse.stale { background: var(--muted); animation: none; }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50%       { opacity: 0.4; transform: scale(0.8); }
  }
  .refresh-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--navy);
    font-family: var(--sans);
    font-size: 11px;
    font-weight: 500;
    padding: 4px 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .refresh-btn:hover { border-color: var(--blue); color: var(--blue); background: #f0f6ff; }
  .refresh-btn:disabled { opacity: 0.5; cursor: default; }

  /* ── Goal cards ── */
  .goal-section {
    background: var(--surface);
    border-radius: 8px;
    padding: 20px 28px;
    margin-bottom: 16px;
    box-shadow: 0 1px 4px rgba(0,66,122,0.06);
    border: 1px solid var(--border);
  }
  .goal-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    margin-bottom: 16px;
  }
  .goal-stat { padding-right: 24px; border-right: 1px solid var(--border); margin-right: 24px; }
  .goal-stat:last-child { border-right: none; margin-right: 0; padding-right: 0; }
  .goal-stat label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.7px; font-weight: 500; display: block; margin-bottom: 5px; }
  .goal-stat .value { font-size: 22px; font-weight: 600; color: var(--text); font-variant-numeric: tabular-nums; }
  .value.green { color: var(--green); }
  .value.red   { color: var(--red); }
  .value.blue  { color: var(--blue); }
  .progress-bar-wrap label { font-size: 11px; color: var(--muted); font-weight: 500; display: flex; justify-content: space-between; margin-bottom: 6px; }
  .progress-track { height: 6px; background: var(--surface2); border-radius: 4px; overflow: hidden; border: 1px solid var(--border); }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--navy), var(--blue)); border-radius: 4px; transition: width 0.6s ease; }

  /* ── Positions table ── */
  .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .section-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.7px; color: var(--muted); }

  .positions-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--surface);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,66,122,0.06);
    border: 1px solid var(--border);
    margin-bottom: 16px;
  }
  .positions-table th {
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px;
    color: var(--muted); text-align: left; padding: 10px 14px;
    background: var(--surface2); border-bottom: 1px solid var(--border);
  }
  .positions-table td { padding: 13px 14px; font-size: 13px; border-bottom: 1px solid #eef1f6; vertical-align: middle; }
  .positions-table tbody tr:last-child td { border-bottom: none; }
  .positions-table tbody tr:hover td { background: #f8fafd; }
  .ticker-cell { font-weight: 700; color: var(--navy); font-size: 14px; letter-spacing: 0.5px; }
  .pnl-pos { color: var(--green); font-weight: 600; }
  .pnl-neg { color: var(--red);   font-weight: 600; }
  .chg-pos { color: var(--green); font-size: 11px; font-weight: 500; }
  .chg-neg { color: var(--red);   font-size: 11px; font-weight: 500; }
  .status-badge {
    display: inline-block; padding: 2px 8px; font-size: 10px; font-weight: 600;
    letter-spacing: 0.5px; text-transform: uppercase; border-radius: 3px; border: 1px solid;
  }
  .status-hold   { color: var(--blue);  border-color: #b3d4f0; background: #eaf4fd; }
  .status-sell   { color: #fff;         border-color: var(--red);   background: var(--red); }
  .status-target { color: #fff;         border-color: #1a7f3c; background: #1a7f3c; }
  .status-stop   { color: var(--red);   border-color: #f5b8c0; background: #fef0f2; }
  .stat-pct { font-size: 11px; margin-top: 4px; font-weight: 500; color: var(--muted); }
  .stat-pct.green { color: var(--green); }
  .stat-pct.red   { color: var(--red); }
  .empty-state { text-align: center; padding: 48px; color: var(--muted); background: var(--surface2); font-size: 13px; }

  /* ── Trade log ── */
  .trade-log {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 20px;
    margin-top: 4px;
    box-shadow: 0 1px 3px rgba(0,66,122,0.05);
  }
  .log-entry { display: flex; justify-content: space-between; padding: 9px 0; border-bottom: 1px solid #eef1f6; font-size: 13px; }
  .log-entry:last-child { border-bottom: none; }
  .log-time { color: var(--muted); font-size: 11px; white-space: nowrap; padding-left: 16px; }

  /* ── Footer note ── */
  .cowork-note {
    text-align: center;
    font-size: 11px;
    color: var(--muted);
    margin-top: 20px;
    padding: 10px;
    border-top: 1px solid var(--border);
  }
  .cowork-note strong { color: var(--navy); }

  /* ── Loading state ── */
  .loading-overlay {
    position: fixed; inset: 0;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
    z-index: 999;
  }
  .spinner {
    width: 32px; height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--navy);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 13px; color: var(--muted); }
</style>
</head>
<body>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Loading positions…</div>
</div>

<!-- Header -->
<div class="header">
  <div>
    <h1>Trading Desk</h1>
    <div class="subtitle">Swing Trade Portfolio — 30 Day Challenge</div>
  </div>
  <div class="header-right">
    <div class="day-badge" id="dayBadge">DAY 1</div>
    <div class="date-display" id="dateDisplay"></div>
  </div>
</div>

<!-- Live price bar -->
<div class="live-bar">
  <div>
    <span class="pulse" id="pulseDot"></span>
    <span id="liveStatus">Connecting…</span>
  </div>
</div>

<!-- Goal section -->
<div class="goal-section">
  <div class="goal-grid">
    <div class="goal-stat">
      <label>Starting Capital</label>
      <div class="value" id="statStart">—</div>
    </div>
    <div class="goal-stat">
      <label>Current Value</label>
      <div class="value blue" id="statCurrent">—</div>
      <div class="stat-pct" id="statCurrentPct"></div>
    </div>
    <div class="goal-stat">
      <label>Total P&amp;L</label>
      <div class="value" id="statPnl">—</div>
      <div class="stat-pct" id="statPnlPct"></div>
    </div>
    <div class="goal-stat">
      <label>Target</label>
      <div class="value" id="statTarget">—</div>
      <div class="stat-pct" id="statTargetPct"></div>
    </div>
  </div>
  <div class="progress-bar-wrap">
    <label>
      <span>Progress to Goal</span>
      <span id="progressPct">0%</span>
    </label>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
  </div>
</div>

<!-- Positions -->
<div class="section-header">
  <div class="section-title" id="positionTitle">Open Positions (0/3)</div>
</div>

<table class="positions-table">
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Shares</th>
      <th>Entry</th>
      <th>Current</th>
      <th>Day Chg</th>
      <th>Market Value</th>
      <th>P&amp;L</th>
      <th>Stop</th>
      <th>Target</th>
      <th>Days Held</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="positionsBody">
    <tr><td colspan="11"><div class="empty-state">Loading positions…</div></td></tr>
  </tbody>
</table>

<!-- Trade Log -->
<div class="trade-log">
  <div class="section-header" style="margin-bottom:10px;">
    <div class="section-title">Trade Log</div>
  </div>
  <div id="tradeLog"><div style="font-size:13px;color:var(--muted);">Loading…</div></div>
</div>

<div class="cowork-note">
  Positions managed by <strong>Claude in Cowork</strong>
</div>

<script>
  // ── State ─────────────────────────────────────────────────────────────
  let positions   = [];
  let tradeLog    = [];
  let livePrices  = {};   // { TICKER: { price, prev } }
  let startCapital  = 15452.95;
  let targetCapital = 30000;
  let startDate   = '2026-02-26';
  let lastRefresh = null;
  let refreshInterval = null;
  let countdownInterval = null;
  const REFRESH_SECS = 30;

  // ── Load positions from JSON ──────────────────────────────────────────
  async function loadPositions() {
    const res  = await fetch('/data/positions.json?_=' + Date.now());
    const data = await res.json();
    positions     = (data.positions  || []).map(p => ({ ...p, current: p.entry }));
    tradeLog      = data.tradeLog    || [];
    startCapital  = data.startCapital  || 15452.95;
    targetCapital = data.target        || 30000;
    startDate     = data.startDate     || '2026-02-26';
  }

  // ── Fetch live prices from /api/prices ────────────────────────────────
  async function fetchPrices() {
    if (positions.length === 0) return;
    const tickers = positions.map(p => p.ticker).join(',');
    const res     = await fetch(`/api/prices?tickers=${tickers}`);
    const data    = await res.json();
    livePrices = data;
    positions.forEach((p, i) => {
      if (data[p.ticker]?.price != null) positions[i].current = data[p.ticker].price;
    });
    lastRefresh = new Date();
  }

  // ── Render ────────────────────────────────────────────────────────────
  function render() {
    // Header
    const today = new Date();
    document.getElementById('dateDisplay').textContent =
      today.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short', year:'numeric'});

    const start = new Date(startDate);
    const day   = Math.max(1, Math.floor((today - start) / 86400000) + 1);
    document.getElementById('dayBadge').textContent = 'DAY ' + day;

    // Goal stats
    const realPnl = tradeLog
      .filter(t => t.type === 'SELL' && t.pnl != null)
      .reduce((s, t) => s + parseFloat(t.pnl), 0);
    const unrealPnl = positions.reduce((s, p) => {
      return s + (parseFloat(p.current) - parseFloat(p.entry)) * parseFloat(p.shares);
    }, 0);
    const totalPnl = realPnl + unrealPnl;
    const curVal   = startCapital + totalPnl;
    const pct      = Math.min(100, Math.max(0, (totalPnl / (targetCapital - startCapital)) * 100));

    document.getElementById('statStart').textContent   = fmt(startCapital);
    document.getElementById('statTarget').textContent  = fmt(targetCapital);

    // % vs starting capital
    const cvPct  = (curVal - startCapital) / startCapital * 100;
    const pnlPct2 = totalPnl / startCapital * 100;
    const tgtPct  = (targetCapital - startCapital) / startCapital * 100;

    const cvEl = document.getElementById('statCurrent');
    cvEl.textContent = fmt(curVal);
    cvEl.className   = 'value ' + (curVal > startCapital ? 'green' : curVal < startCapital ? 'red' : 'blue');
    const cvPctEl = document.getElementById('statCurrentPct');
    cvPctEl.textContent = (cvPct >= 0 ? '+' : '') + cvPct.toFixed(2) + '% vs start';
    cvPctEl.className   = 'stat-pct ' + (cvPct > 0 ? 'green' : cvPct < 0 ? 'red' : '');

    const pnlEl = document.getElementById('statPnl');
    pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + fmt(totalPnl);
    pnlEl.className   = 'value ' + (totalPnl > 0 ? 'green' : totalPnl < 0 ? 'red' : '');
    const pnlPctEl = document.getElementById('statPnlPct');
    pnlPctEl.textContent = (pnlPct2 >= 0 ? '+' : '') + pnlPct2.toFixed(2) + '% of capital';
    pnlPctEl.className   = 'stat-pct ' + (pnlPct2 > 0 ? 'green' : pnlPct2 < 0 ? 'red' : '');

    const tgtPctEl = document.getElementById('statTargetPct');
    tgtPctEl.textContent = '+' + tgtPct.toFixed(1) + '% gain needed';
    tgtPctEl.className   = 'stat-pct';

    document.getElementById('progressPct').textContent = pct.toFixed(1) + '%';
    document.getElementById('progressFill').style.width = pct + '%';

    // Positions table
    document.getElementById('positionTitle').textContent = `Open Positions (${positions.length}/3)`;
    const tbody = document.getElementById('positionsBody');
    if (positions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="11"><div class="empty-state">No open positions</div></td></tr>';
    } else {
      tbody.innerHTML = positions.map(p => {
        const entry   = parseFloat(p.entry);
        const current = parseFloat(p.current);
        const shares  = parseFloat(p.shares);
        const prev    = livePrices[p.ticker]?.prev;
        const mv      = current * shares;
        const pnl     = (current - entry) * shares;
        const pnlPct  = ((current - entry) / entry * 100);
        const days    = Math.floor((new Date() - new Date(p.date)) / 86400000);
        const pnlCls  = pnl >= 0 ? 'pnl-pos' : 'pnl-neg';
        const pnlStr  = (pnl >= 0 ? '+' : '') + '$' + Math.abs(pnl).toFixed(2) + ' (' + (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%)';

        const liveData = livePrices[p.ticker];
        let chgStr = '—';
        if (liveData?.change != null) {
          // use pre-calculated day change from Yahoo quote API
          const chg    = liveData.change;
          const chgPct = liveData.changePct;
          const cls    = chg >= 0 ? 'chg-pos' : 'chg-neg';
          chgStr = `<span class="${cls}">${chg >= 0 ? '+' : ''}${chg.toFixed(2)} (${chgPct >= 0 ? '+' : ''}${chgPct.toFixed(2)}%)</span>`;
        } else if (prev != null) {
          // fallback: calculate from prev close
          const chg    = current - prev;
          const chgPct = (chg / prev * 100);
          const cls    = chg >= 0 ? 'chg-pos' : 'chg-neg';
          chgStr = `<span class="${cls}">${chg >= 0 ? '+' : ''}${chg.toFixed(2)} (${chgPct >= 0 ? '+' : ''}${chgPct.toFixed(2)}%)</span>`;
        }

        // Colour: green above entry, red below, default text if flat
        const priceColor = current > entry ? 'var(--green)' : current < entry ? 'var(--red)' : 'var(--text)';

        // Status badge: report signal → target hit → stop hit → hold
        const stopVal = parseFloat(p.stop   || 0);
        const tgtVal  = parseFloat(p.target || 0);
        let statusBadge;
        if (p.signal === 'SELL') {
          statusBadge = '<span class="status-badge status-sell">⚠ Sell</span>';
        } else if (tgtVal > 0 && current >= tgtVal) {
          statusBadge = '<span class="status-badge status-target">✓ Target</span>';
        } else if (stopVal > 0 && current <= stopVal) {
          statusBadge = '<span class="status-badge status-stop">✕ Stop</span>';
        } else {
          statusBadge = '<span class="status-badge status-hold">Hold</span>';
        }

        return `<tr>
          <td class="ticker-cell">${p.ticker}</td>
          <td>${shares}</td>
          <td style="font-variant-numeric:tabular-nums;">$${entry.toFixed(4)}</td>
          <td style="font-variant-numeric:tabular-nums; font-weight:600; color:${priceColor};">$${current.toFixed(2)}</td>
          <td>${chgStr}</td>
          <td style="font-variant-numeric:tabular-nums; color:${priceColor};">$${mv.toFixed(2)}</td>
          <td class="${pnlCls}" style="font-variant-numeric:tabular-nums;">${pnlStr}</td>
          <td style="color:var(--red); font-variant-numeric:tabular-nums;">${stopVal > 0 ? '$'+stopVal.toFixed(2) : '—'}</td>
          <td style="color:var(--green); font-variant-numeric:tabular-nums;">${tgtVal > 0 ? '$'+tgtVal.toFixed(2) : '—'}</td>
          <td>${days}d</td>
          <td>${statusBadge}</td>
        </tr>`;
      }).join('');
    }

    // Trade log
    const logEl = document.getElementById('tradeLog');
    if (tradeLog.length === 0) {
      logEl.innerHTML = '<div style="font-size:13px;color:var(--muted);">No trades recorded yet.</div>';
    } else {
      logEl.innerHTML = tradeLog.slice().reverse().map(t => `
        <div class="log-entry">
          <div>
            <strong style="color:${t.type==='BUY' ? 'var(--green)' : 'var(--red)'}; font-size:12px;">${t.type}</strong>
            <span style="margin-left:10px; font-weight:600;">${t.ticker}</span>
            <span style="color:var(--muted); margin-left:8px;">${t.shares} shares @ $${parseFloat(t.price).toFixed(4)}</span>
            ${t.pnl != null ? `<span style="margin-left:10px; font-weight:600; color:${parseFloat(t.pnl)>=0?'var(--green)':'var(--red)'};">${parseFloat(t.pnl)>=0?'+':''}$${Math.abs(parseFloat(t.pnl)).toFixed(2)}</span>` : ''}
            ${t.reason ? `<span style="color:var(--muted); font-size:11px; margin-left:8px;">${t.reason}</span>` : ''}
          </div>
          <div class="log-time">${t.date}</div>
        </div>`).join('');
    }
  }

  // ── Live status bar ───────────────────────────────────────────────────
  function updateStatus() {
    const dot    = document.getElementById('pulseDot');
    const status = document.getElementById('liveStatus');
    if (!lastRefresh) return;
    const secs   = Math.floor((new Date() - lastRefresh) / 1000);
    const next   = Math.max(0, REFRESH_SECS - secs);
    if (secs < REFRESH_SECS + 5) {
      dot.className   = 'pulse';
      status.textContent = `Live prices · last updated ${secs}s ago · next refresh in ${next}s`;
    } else {
      dot.className   = 'pulse stale';
      status.textContent = `Prices may be stale · last updated ${secs}s ago`;
    }
  }

  // ── Manual refresh ────────────────────────────────────────────────────
  async function manualRefresh() {
    const btn    = document.getElementById('refreshBtn');
    const status = document.getElementById('liveStatus');
    btn.disabled = true;
    btn.textContent = '↻ Fetching…';
    status.textContent = 'Fetching prices…';
    try {
      await fetchPrices();
      render();
    } catch(e) {
      document.getElementById('pulseDot').className = 'pulse stale';
      status.textContent = '⚠ Could not fetch prices — try again';
    } finally {
      btn.disabled    = false;
      btn.textContent = '↻ Refresh now';
    }
  }

  // ── Auto-refresh loop ─────────────────────────────────────────────────
  function startAutoRefresh() {
    if (refreshInterval)  clearInterval(refreshInterval);
    if (countdownInterval) clearInterval(countdownInterval);
    refreshInterval   = setInterval(async () => {
      await fetchPrices();
      render();
    }, REFRESH_SECS * 1000);
    countdownInterval = setInterval(updateStatus, 1000);
  }

  // ── Helpers ───────────────────────────────────────────────────────────
  function fmt(n) {
    return '$' + Math.abs(n).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  // ── Boot ──────────────────────────────────────────────────────────────
  async function init() {
    try {
      await loadPositions();
      render();
      await fetchPrices();
      render();
      updateStatus();
      startAutoRefresh();
    } catch(e) {
      console.error('Init failed:', e);
      document.getElementById('liveStatus').textContent = '⚠ Failed to load data — check connection';
    } finally {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  }

  init();
</script>
</body>
</html>
